<!DOCTYPE html>
<html lang="en">

<head>
	<title>REBIPP</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
		integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<link rel="stylesheet" href="css/eco_fichas.css">
<script type="text/javascript" src="/js/main.js"></script>
<script type="text/javascript" src="/js/internationalization.js?v=1"></script>
<script type="text/javascript" src="js/interaction-worker.js"></script>
<script type="text/javascript" src="js/report-worker.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
	integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
	integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">

</script>
</head>

<body>

	<div class="container">

		<div class="row">
			<div class="col-md-10 d-flex">
				<div class="logo"><img
						src="https://www.rebipp.org.br/wp-content/uploads/2017/08/12654381_10153871230836407_6739059577886817957_n-01-768x949.png"
						alt="REBIPP" height="194px" /></div>
				<div class="" style="margin: auto 0;">
					<img src="/images/surpass_logo.png" alt="SURPASS" height="140px" />
				</div>
			</div>
			<div class="col-md-2 pt-3 " style="position: relative">
				<a style="color: #fff" class="nav-link btn btn-success" aria-current="page" href="/how-to-contribute">
					How to Contribute
				</a>
				<div class="align-bottom"
					style="bottom: 0; right: 0; position: absolute; float: right; margin-bottom: 1em; background-color: hsla(0, 0%, 100%, 0.582);">
					<ul class="nav justify-content-end" style="margin: 0.5em">
						<li class="nav-item">
							<a style="padding: 0px;" class="nav-link active" aria-current="page" href="#">
								<img onclick="setLanguage('pt-BR') || translatePage() || updateInteractionList()"
									src="/images/pt_BR.png">
							</a>
						</li>
						<li class="nav-item">
							<a style="padding: 0px; margin-left: 0.5em;" class="nav-link" href="#">
								<img onclick="setLanguage('en-US') || translatePage() || updateInteractionList()"
									src="/images/en_GB.png">
							</a>
						</li>
						<li class="nav-item">
							<a style="padding: 0px; margin-left: 0.5em;" class="nav-link" href="#">
								<img onclick="setLanguage('es-ES') || translatePage() || updateInteractionList()"
									src="/images/es_ES.png">
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div class="container pt-3" style="background-color: white;">
		<div class="container mt-3">
			<div class="row">
				<div class="col-md-10">
					<h3 class="translate-html" id="mainPageTitle">Search for Interactions Data</h3>
				</div>
				<div class="col-md-2">
					<button id="download" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight"
						aria-controls="offcanvasRight" type="button" style="float: right;"
						class="btn btn-outline-primary translate-html">Download</button>
				</div>
			</div>
		</div>
		<div class="container mt-3">
			<div class="row">
				<div class="col-md-3">
					<div class="input-group ">
						<span class="input-group-text translate-html" id="plantNameLabel">Plant name</span>
						<input id="filterPlantName" type="text" class="form-control" onkeyup="updateInteractionList()"
							placeholder="Plant name" aria-label="Username" aria-describedby="basic-addon1">
					</div>
				</div>
				<div class="col-md-3">
					<div style="min-width: 1rem; width: 100%;" class="dropdown">
						<button style="min-width: 1rem; width: 100%;" class="btn btn-secondary dropdown-toggle" type="button"
							id="dropdownMenuInteractionType" data-bs-toggle="dropdown" aria-expanded="false">Interaction type</button>
						<ul id="interactionTypeOptions" style="min-width: 1rem; width: 100%;" class="dropdown-menu"
							aria-labelledby="dropdownMenuInteractionType">
						</ul>
					</div>
				</div>
				<div class="col-md-3">
					<div class="input-group ">
						<span class="input-group-text translate-html" id="animalNameLabel">Animal name</span>
						<input id="filterAnimalName" type="text" class="form-control" onkeyup="updateInteractionList()"
							placeholder="Animal name" aria-label="Username" aria-describedby="basic-addon1">
					</div>
				</div>
				<div class="col-md-3">
					<div class="input-group ">
						<span class="input-group-text translate-html" id="sourceLabel">Source</span>
						<input id="filterSource" type="text" class="form-control" onkeyup="updateInteractionList()"
							placeholder="Source" aria-label="Username" aria-describedby="basic-addon1">
					</div>
				</div>
			</div>
		</div>

		<div class="container mt-3">
			<div class="row">
				<div class="col d-flex align-items-center">
					<span style="margin-right: 1em;">Modo de visualização:</span>
					<div class="ml-2">
						<button id="list-button" type="button" class="btn btn-primary active mr-2">
							<i class="fa fa-list"></i>
						</button>
						<button id="map-button" type="button" class="btn btn-primary mr-2">
							<i class="fa fa-map"></i>
						</button>
						<button id="chart-button" type="button" class="btn btn-primary">
							<i class="fa fa-bar-chart"></i>
						</button>
					</div>
				</div>
			</div>
		</div>

	</div>



	<div class="container pb-5" style="background-color: white; ">
		<div style="padding-top: 0px; padding-left: 0px;" class="row ">
			<div style="padding-left: 0px;" class="col-md-12">
				<div class="container mt-3">
					<div id="interaction-list" class="list-group">

					</div>
					<div id="map-view">
						
						<div style="margin-bottom: 1em; padding-left: 0px;" class="container mt-3">
							<div class="col-md-3">
								<div style="min-width: 1rem; width: 100%;" class="dropdown">
									<button style="min-width: 1rem; width: 100%;" class="btn btn-secondary dropdown-toggle" type="button"
										id="dropdownMenuColorMap" data-bs-toggle="dropdown" aria-expanded="false">Cores por</button>
									<ul id="map-color-selector" style="min-width: 1rem; width: 100%;" class="dropdown-menu"
										aria-labelledby="dropdownMenuColorMap">
										<li><a class="dropdown-item" href="javascript:selectMapColor('')">-</a></li>
										<li><a class="dropdown-item" href="javascript:selectMapColor('Planta')">Planta</a></li>
										<li><a class="dropdown-item" href="javascript:selectMapColor('Interação')">Interação</a></li>
										<li><a class="dropdown-item" href="javascript:selectMapColor('Animal')">Animal</a></li>
									</ul>
								</div>
							</div>
						</div>
						<div id="map" style="width: 100%; height: 500px;"></div>
					</div>

					<div id="chart-view" class="container pb-5" style="background-color: white; padding-left: 0px; padding-top: 0px; margin-bottom: 0px">
									<div style="padding-left: 0px; margin-top: 0px; margin-bottom: 1em;" class="container mt-3">
										<div style="padding-top: 0px; margin-top: 0px" class="col-md-3">
											<div style="min-width: 1rem; width: 100%; padding-top: 0px; margin-top: 0px" class="dropdown">
												<button style="min-width: 1rem; width: 100%; z-index: 10000;" class="btn btn-secondary dropdown-toggle" type="button"
													id="dropdownMenuColorMap" data-bs-toggle="dropdown" aria-expanded="false">Agrupar por nome científico</button>
												<ul id="selector-chart-group-by" style="min-width: 1rem; width: 100%; z-index: 10000;" class="dropdown-menu"
													aria-labelledby="dropdownMenuColorMap">
													<li style="z-index: 10000;"><a class="dropdown-item" href="javascript:selectChartGroupBy('nome científico')">Nome científico</a></li>
													<li><a class="dropdown-item" href="javascript:selectChartGroupBy('gênero')">Gênero</a></li>
													<li><a class="dropdown-item" href="javascript:selectChartGroupBy('família')">Família</a></li>
													<li><a class="dropdown-item" href="javascript:selectChartGroupBy('ordem')">Ordem</a></li>
													<li><a class="dropdown-item" href="javascript:selectChartGroupBy('filo')">Filo</a></li>
													<li><a class="dropdown-item" href="javascript:selectChartGroupBy('reino')">Reino</a></li>
												</ul>
											</div>
										</div>
									</div>
									<div id="sankey_basic" style="width: 100%; height: 500px;"></div>
					</div>

				</div>
			</div>
			<div class="col-md-12 mt-3">
				<nav aria-label="Page navigation">
					<ul class="pagination justify-content-center pagination-md">
						<li class="page-item">
							<a class="page-link" href="javascript:previousPage()" aria-label="Previous">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>
						<li class="page-item"><a id="current_page" class="page-link" href="#">1</a></li>
						<li class="page-item">
							<a class="page-link" href="javascript:nextPage()" aria-label="Next">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>
					</ul>
				</nav>
			</div>
		</div>
	</div>

	<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
		<div class="offcanvas-header">
			<h5 id="offcanvasRightLabel">Download</h5>
			<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcanvas-body">
			<button id="downloadCsvInteractionsButton" type="button" class="btn btn-primary">
				CSV
			</button>
			<button id="downloadJsonInteractionsButton" type="button" class="btn btn-primary">
				JSON
			</button>
			<button id="downloadDwcInteractionsButton" type="button" class="btn btn-primary">
				Darwin Core Archive
			</button>
			<div class="container">

				<div class="row mt-5">
					<div class="col-md-12">
						<dl class="row">
							<h3>Dataset description</h3>
							<p>The dataset downloaded are commposed by all of the filtered records.</p>

							<dt class="col-sm-7">Language:</dt>
							<dd id="downloadLanguage" class="col-sm-5"></dd>

							<dt class="col-sm-7">Count of records:</dt>
							<dd id="downloadCountRecord" class="col-sm-5"></dd>

							<dt class="col-sm-7">Count of sources:</dt>
							<dd id="downloadCountSources" class="col-sm-5"></dd>

							<dt class="col-sm-7">Count of animal species:</dt>
							<dd id="downloadCountAnimalSpecies" class="col-sm-5"></dd>

							<dt class="col-sm-7">Count of plant species:</dt>
							<dd id="downloadCountPlantSpecies" class="col-sm-5"></dd>
						</dl>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="contactForm">

		<h1 style="margin-bottom:1em">Encontrou algum problema?</h1>
		<small>Comunique-nos sobre qualquer problema no sistema, nos dados ou nas imagens.</small>


		<div style="margin:1em">
			<label style="margin:1em">
				Onde foi percebido o problema?
			</label>
			<select id="feedback-category">
				<option value="" selected></option>
				<option value="data">Dados</option>
				<option value="system">Sistema</option>
			</select>
		</div>
		<textarea id="feedback-msg" placeholder="Descreva com detalhes o que precisa ser corrigido"
			style="height: 80px; resize: none; margin: .8em auto; font-family: inherit;  text-transform: inherit;  font-size: inherit; display: block;  width: 280px;  padding: .4em;"></textarea>
		<div style="margin:1em">
			<label>
				Email de contato
			</label>
			<input type="email" id="email"
				style="margin: .8em auto; font-family: inherit;  text-transform: inherit;  font-size: inherit; display: block;  width: 280px;  padding: .4em;" />
		</div>
		<div id="no-auth">

			<button id="send-feedback" class="loginBtn loginBtn--google">
				Enviar
			</button>

		</div>
		<div id="auth">
			<input onclick="exitFeedback();" class="formBtn" type="reset" value="Sair" />
		</div>
		<div id="result"></div>
	</div>
	<button id="popup" class="feedback-button" onclick="toggle_visibility()">Reportar</button>
</body>
<script>
	let page = 1
	const nextPage = () => {
		page++
		$("#current_page").html(page)
		updateInteractionList()
	}
	const previousPage = () => {
		if (page === 1) {
			return
		}
		page--
		$("#current_page").html(page)
		updateInteractionList()
	}
	let selectedInteractionType = ""
	const selectInteractionType = (type) => {
		selectedInteractionType = type
		if (selectedInteractionType === "") {
			const label = internationalization["interactionType"][localStorage.getItem("language") || "en-US"]
			$("#dropdownMenuInteractionType").html(`${label}`)
		} else {
			$("#dropdownMenuInteractionType").html(type)
		}
		updateInteractionList()
	}
	let colorBy = "-"
	const selectMapColor = (selectedColorBy) => {
		selectedColorMap = selectedColorBy
		colorBy = selectedColorBy
		if (selectedColorMap === "") {
			const label =
				selectedColorBy //internationalization["interactionType"][localStorage.getItem("language") || "en-US"]
			$("#select-map-color").html(`${label}`)
			$("#dropdownMenuColorMap").html(`Cor por ${label}`)
		} else {
			$("#select-map-color").html(selectedColorBy)
			$("#dropdownMenuColorMap").html(`Cor por ${selectedColorBy}`)
		}
		updateColorMap(selectedColorMap)
	}
	const updateInteractionList = async () => {
		$("#map-view").hide()
		$("#chart-view").hide()
		$("#interaction-list").show()
		$("#interaction-list").html("loading...")
		const interactions = await getInteractions(page, selectedInteractionType)
		if (interactions.length === 0) {
			previousPage()
		}
		$("#interaction-list").html("")
		interactions.forEach(interaction => {
			$("#interaction-list").append(`
				<a href="https://docs.google.com/spreadsheets/d/${interaction["experimentId"]}" target="blank" class="list-group-item list-group-item-action " aria-current="true">
					<div class="d-flex w-100 justify-content-between">
						<h5 class="mb-1"><span class="link-primary"><i>${interaction["plant:dwc:Taxon:scientificName"]["originalValue"]}</i></span> <span
								class="link-secondary">${interaction["interaction:rebipp:Interaction:interactionType"]["vocabulary"]?.toLowerCase()}</span> <span class="link-danger"><i>${interaction["animal:dwc:Taxon:scientificName"]["originalValue"]}</i></span></h5>
						<small>${interaction["datasetMetadata"]["eml:dataset:coverage:temporalCoverage:endDate"]}</small>
					</div>
					<div class="blockquote"></div>
					<figcaption class="blockquote-footer">
						${interaction["datasetMetadata"]["eml:dataset:title:en"]} (${interaction["datasetMetadata"]["eml:dataset:creator:individualName"]})
					</figcaption>
				</a>
				`)
		})
		updateDownloadMetadata()
	}
	const updateDownloadMetadata = async () => {
		const metadata = await getDownloadMetadata(selectedInteractionType)
		$("#downloadCountRecord").html(metadata.countRecords)
		$("#downloadCountSources").html(metadata.countSources)
		$("#downloadCountPlantSpecies").html(metadata.countPlantSpecies)
		$("#downloadCountAnimalSpecies").html(metadata.countAnimalSpecies)
	}

	function exitFeedback() {
		$('#contactForm').fadeOut();
	}
	$("#send-feedback").click(function (e) {
		var data = {
			errorDescription: $("#feedback-msg").val(),
			errorType: $("#feedback-category").val(),
			email: $("#email").val()
		}
		if (data.errorDescription != "" || data.errorType || data.email) {
			reportError(data, result => {

				$("#feedback-msg").val("")
				$("#feedback-category").val("")
				$('#contactForm').fadeOut()

			})
			exitFeedback()
			alert("Obrigado pela colaboração. \nEntraremos em contato informando sobre a correção do problema.")
		} else {
			alert("É necessário preencher todos os campos.")
		}
		e.preventDefault();
	})

	function toggle_visibility() {
		$('#contactForm').fadeToggle();
	}
	$(function () {
		$("#map-view").hide()
		$("#chart-view").hide()
		$("#filterPlantName").attr("placeholder", internationalization["plantNameLabel"][localStorage.getItem(
			"language") || "en-US"]);
		$("#filterAnimalName").attr("placeholder", internationalization["animalNameLabel"][localStorage.getItem(
			"language") || "en-US"]);
		$("#filterSource").attr("placeholder", internationalization["sourceLabel"][localStorage.getItem("language") ||
			"en-US"
		]);
		getInteractionTypes().then(interactionTypes => {
			const label = internationalization["interactionType"][localStorage.getItem("language") || "en-US"]
			$("#dropdownMenuInteractionType").html(`${label}`)
			$("#interactionTypeOptions").append(
				`<li><a class="dropdown-item" href="javascript:selectInteractionType('')">-</a></li>`)
			interactionTypes.forEach(interactionType => {
				if (interactionType)
					$("#interactionTypeOptions").append(
						`<li><a class="dropdown-item" href="javascript:selectInteractionType('${interactionType}')">${interactionType}</a></li>`
					)
			})
		})
		$("#current_page").html(page)
		updateInteractionList()
		$(".btn").click(function () {
			$(".btn").removeClass("active")
			$(this).addClass("active")
			if ($(this).attr('id') === 'map-button') {
				displayMap()
			} else if ($(this).attr('id') === 'list-button') {
				updateInteractionList()
			} else if ($(this).attr('id') === 'chart-button') {
				displayChart()
			}

		})

	})


	$("#downloadJsonInteractionsButton").click(function () {
		downloadJsonInteractions(selectedInteractionType)
	})
	$("#downloadCsvInteractionsButton").click(function () {
		downloadCsvInteractions(selectedInteractionType)
	})
	$("#downloadDwcInteractionsButton").click(function () {
		downloadDwcInteractions(selectedInteractionType)
	})


	const colors = {
		"blue": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"gold": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"red": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"green": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"orange": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"yellow": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yello.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"violet": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"grey": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		}),
		"black": new L.Icon({
			iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png`,
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		})
	}
	let map
	const displayMap = async () => {
		$('#dropdownMenuColorMap').click(function(event) {
			$('.dropdown-menu').css('z-index', '10000');
		})
		$("#interaction-list").hide()
		$("#map-view").show()
		$("#chart-view").hide()

		const data = await getInteractions(null, selectedInteractionType)
		const prepareData = data.filter(item => {
			return item["interaction:dwc:Location:decimalLatitude"]["originalValue"]?.length > 0 && item[
				"interaction:dwc:Location:decimalLongitude"]["originalValue"]?.length > 0
		})

		let preparedColor = {}
		const prepareColors = () => {
			let i = 0

			if (colorBy === 'Planta') {
				prepareData.map(item => {
					if (!preparedColor[item["plant:dwc:Taxon:scientificName"]["originalName"]]) {
						preparedColor[item["plant:dwc:Taxon:scientificName"]["originalName"]] = Object.keys(colors)[i]
						i = i < 9 ? i + 1 : 0
					}
				})
			} else if (colorBy === 'Interação') {
				prepareData.map(item => {
					if (!preparedColor[item["interaction:rebipp:Interaction:interactionType"]["state"]]) {
						preparedColor[item["interaction:rebipp:Interaction:interactionType"]["state"]] = Object.keys(
							colors)[i]
						i = i < 9 ? i + 1 : 0
					}
				})
			} else if (colorBy === 'Animal') {
				prepareData.map(item => {
					if (!preparedColor[item["animal:dwc:Taxon:scientificName"]["originalName"]]) {
						preparedColor[item["animal:dwc:Taxon:scientificName"]["originalName"]] = Object.keys(colors)[i]
						i = i < 9 ? i + 1 : 0
					}
				})
			} else {

			}
		}
		prepareColors()

		console.log(prepareData)

		let interactions = L.layerGroup(prepareData.map(item => {
			const lat = item["interaction:dwc:Location:decimalLatitude"]["originalValue"]
			const lng = item["interaction:dwc:Location:decimalLongitude"]["originalValue"]
			const label =
				`<h5 class="mb-1"><span class="link-primary"><i>${item["plant:dwc:Taxon:scientificName"]["originalValue"]}</i></span> <span
								class="link-secondary">${item["interaction:rebipp:Interaction:interactionType"]["vocabulary"]?.toLowerCase()}</span> <span class="link-danger"><i>${item["animal:dwc:Taxon:scientificName"]["originalValue"]}</i></span></h5>`
			if (colorBy === 'Planta') {
				const icon = colors[preparedColor[item["plant:dwc:Taxon:scientificName"]["originalName"]]]
				return L.marker([lat, lng], {
					icon
				}).bindPopup(label)
			} else if (colorBy === 'Interação') {
				const icon = colors[preparedColor[item["interaction:rebipp:Interaction:interactionType"]["state"]]]
				return L.marker([lat, lng], {
					icon
				}).bindPopup(label)
			} else if (colorBy === 'Animal') {
				const icon = colors[preparedColor[item["animal:dwc:Taxon:scientificName"]["originalName"]]]
				return L.marker([lat, lng], {
					icon
				}).bindPopup(label)
			} else {
				const icon = colors["blue"]
				return L.marker([lat, lng], {
					icon
				}).bindPopup(label)
			}
		}))

		let osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '© OpenStreetMap'
		});

		if (!map) {
			map = L.map('map', {
				center: [-15.83, -47.86],
				zoom: 4,
				layers: [osm, interactions]
			})
		} else {
			// If the map instance exists, remove the existing layers and add new ones
			map.eachLayer((layer) => {
				map.removeLayer(layer);
			});

			osm.addTo(map);
			interactions.addTo(map);
		}

		updateDownloadMetadata()
	}
	const updateColorMap = colorBy => {
		displayMap()
	}



	let chart
	let chartGroupBy = "nome científico"
	const displayChart = async () => {
		$("#interaction-list").hide()
		$("#map-view").hide()
		$("#chart-view").show()

		const rawInteractionData = await getInteractions(null, selectedInteractionType)
		let interactionAggregation = {}
		rawInteractionData.forEach(item => {
			let key
			key = (item["animal:dwc:Taxon:scientificName"]["originalValue"] || "Undefined") + "|" + (item[
				"plant:dwc:Taxon:scientificName"]["originalValue"] || "Undefined")
			if(chartGroupBy === 'gênero') {
				key = (item["animal:dwc:Taxon:genus"]["originalValue"] || "Undefined") + "|" + (item[
				"plant:dwc:Taxon:genus"]["originalValue"] || "Undefined")
			} else if(chartGroupBy === 'família') {
				key = (item["animal:dwc:Taxon:family"]["originalValue"] || "Undefined") + "|" + (item[
				"plant:dwc:Taxon:family"]["originalValue"] || "Undefined")
			}else if(chartGroupBy === 'ordem') {
				key = (item["animal:dwc:Taxon:order"]["originalValue"] || "Undefined") + "|" + (item[
				"plant:dwc:Taxon:order"]["originalValue"] || "Undefined")
			} else if(chartGroupBy === 'filo') {
				key = (item["animal:dwc:Taxon:phylum"]["originalValue"] || "Undefined") + "|" + (item[
				"plant:dwc:Taxon:phylum"]["originalValue"] || "Undefined")
			} else if(chartGroupBy === 'reino') {
				key = (item["animal:dwc:Taxon:kingdom"]["originalValue"] || "Undefined") + "|" + (item[
				"plant:dwc:Taxon:kingdom"]["originalValue"] || "Undefined")
			} 
			interactionAggregation[key] = interactionAggregation[key] ? interactionAggregation[key] + 1 : 1
		})

		let rawData = Object.keys(interactionAggregation).map(key => {
			const animal = key.split("|")[0]
			const plant = key.split("|")[1]
			return [animal, plant, interactionAggregation[key]]
		})

		var data = new google.visualization.DataTable();
		data.addColumn('string', 'From');
		data.addColumn('string', 'To');
		data.addColumn('number', 'Count of interactions');
		data.addRows(rawData);

		// Sets chart options.
		var options = {
			width: "100%",
		};
		if (!chart) {
			// Instantiates and draws our chart, passing in some options.
			chart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
		}
		chart.draw(data, options);

		updateDownloadMetadata()
	}
	const selectChartGroupBy = groupBy => {
		chartGroupBy = groupBy
		displayChart()

	}
	google.charts.load('current', {
		'packages': ['sankey']
	});
</script>

</html>